<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>NATS events and beyond</title><link rel="stylesheet" href="./reveal.js/dist/reset.css"><link rel="stylesheet" href="./reveal.js/dist/reveal.css"><link rel="stylesheet" href="./reveal.js/dist/theme/black.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* source blocks */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* auto-animate feature */
/* hide the scrollbar when auto-animating source blocks */
.reveal pre[data-auto-animate-target] {
  overflow: hidden;
}

.reveal pre[data-auto-animate-target] code {
  overflow: hidden;
}

/* add a min width to avoid horizontal shift on line numbers */
code.hljs .hljs-ln-line.hljs-ln-n {
  min-width: 1.25em;
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}

.byline {
  font-size:.8em
}
ul.byline {
  list-style-type: none;
}
ul.byline li + li {
  margin-top: 0.25em;
}
</style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/v4-shims.min.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title" data-transition-speed="fast"><h1>NATS events and beyond</h1><div class="preamble"><div class="paragraph"><p>Introduction for developers</p></div>
<div class="paragraph"><p>by Harupa Dzmitry &lt;<a href="mailto:d.harupa@pin-up.team">d.harupa@pin-up.team</a>&gt;</p></div>
<div class="paragraph"><p>@2022</p></div></div></section>
<section id="_about_author" class="columns"><h2>About author</h2><div class="slide-content"><div class="openblock column"><div class="content"><div class="ulist"><ul><li><p>&gt;13 years in development</p></li><li><p>&gt;6 years as Go lang dev</p></li><li><p>&gt;5 in Gambling industry (Game dev, Producer, Game Master, Mathematician)</p></li><li><p>Developed 4 games for Booongo (as partners)</p></li><li><p>Performed 5 game maths for IGT</p></li><li><p>Certified Kubernetes Application Developer</p></li><li><p>For now solution architect in Pin-Up company</p></li></ul></div></div></div>
<div class="openblock column"><div class="content"><div class="imageblock"><img src="images/AVA.jpg" alt="AVA"></div></div></div></div></section>
<section id="_agenda" data-autoslide="60000"><h2>Agenda</h2><div class="slide-content"><div class="ulist"><ul><li><p>NATS</p><div class="ulist"><ul><li><p>Overview</p></li><li><p>Quality of service</p></li></ul></div></li><li><p>NATS concept</p><div class="ulist"><ul><li><p>Subject-Based Messaging</p></li><li><p>Core</p></li><li><p>JetStream</p></li><li><p>Subject Mapping and Partitioning</p></li></ul></div></li><li><p>Future of NATS</p></li><li><p>Q/A</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Мы пройдемся по высокоуровнему дизайну натсу и его ключевым особенностям.</p></div>
<div class="paragraph"><p>Рассмотрим основные концепции MQ и рассмотрим что нового нам готовят новые версии НАТС или что интересного было недавно добавлено.</p></div>
<div class="paragraph"><p>В конце доклада у нас будет 15 минут на ваши вопросы. Я буду стараться уложиться в 45 минут!</p></div></aside></div></section>
<section><section id="_nats" data-autoslide="60000"><h2>NATS</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>message oriented middleware</p></div></blockquote></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content"><div class="title">With NATS, application developers can</div><div class="ulist"><ul><li><p>Effortlessly build distributed and scalable client-server applications.</p></li><li><p>Store and distribute data in realtime in a general manner. This can flexibly be achieved across various environments, languages, cloud providers and on-premises systems.</p></li></ul></div></td></tr></table></div><aside class="notes"><div class="paragraph"><p>Сами разработчики называют NATS: <code>сообщения-ориентированным посредником</code> и я думаю, после того как мы углубимся в теорию вы с этим согласитесь</p></div>
<div class="paragraph"><p>На высоком уровне натс решает несколько зщадачь:</p></div>
<div class="ulist"><ul><li><p>Возможно разрабатывать без особого труда распределенные и масштабируемые клиент-сервер приложения</p></li><li><p>Хранить и распространять данные в реальном времени в общем виде</p></li></ul></div></aside></div></section><section id="_what_do_you_use_nats_for" data-autoslide="60000"><h2>What do you use NATS for?</h2><div class="slide-content"><div class="paragraph"><p>You can use NATS to exchange information with and make requests to other applications.
You can also use NATS to make your application into a distributed peer-to-peer application.</p></div>
<div class="paragraph"><p>At a high level your application can use NATS to:</p></div>
<div class="ulist"><ul><li><p>Send (Publish) information to other applications or instances of your application.</p></li><li><p>Receive (Subscribe) information (in real-time or whenever your application runs) from other applications or instances of your application.</p></li><li><p>Make a request to a server or the service provided by another application.</p></li><li><p>Store shared (consistent) state/data between other applications or instances of your application.</p></li><li><p>Be informed in real-time about any new data being sent, or any changes to the shared state/data.</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Для чего мы можем использовать НАТС?</p></div>
<div class="paragraph"><p>Конечно же для обмена информацией и запросов с другими приложениями а  так же строить распределенные приложения.</p></div>
<div class="paragraph"><p>На высоком уровне наши приложения могут:</p></div>
<div class="ulist"><ul><li><p>отправлять информацию другим приложениям или экзэмплярам нашего приложения.</p></li><li><p>в реальном времени или во время работы приложения получать сообщения от других приложений или экземлпяров нашего приложения.
(Обратите внимание, что экземпляры - говорит о распределении внутри собсвенного сервиса, когда 1 приложение обшается между своими репликами, хотя я предпочитаю придерживаться практик 12 факторного приложения и использовать WORKER подход, хотя это и есть другой инстанс так же :)</p></li><li><p>Точно так же мы моежм использовать RPC подход.</p></li><li><p>Хранить общие (и постоянные) состояние или данные между другими приложениями или экземплярами нашего.</p></li><li><p>Получать нотифиации об изменениях общих данных или состояний.</p></li></ul></div></aside></div></section><section id="_dont_worry" data-autoslide="60000"><h2>Don&#8217;t worry</h2><div class="slide-content"><div class="ulist"><ul><li><p>Who sends the information that you want to receive.</p></li><li><p>Who  is interested in the information you are sending to others, or how many are interested or where they are.</p></li><li><p>How many partitions or servers there are in the cluster.</p></li><li><p>Security (just identify yourself).</p></li><li><p>Whether your application is up and running at the time the information is sent or not (using JetStream).</p></li><li><p>Flow control (using JetStream)</p></li><li><p>QoS flexibility</p></li><li><p>Fault-tolerance</p></li><li><p>The topology of the NATS server infrastructure or it is architected.</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Разработчики предлагают ряд консернов о которых нам предлагают забыть при разработке приложений</p></div>
<div class="ulist"><ul><li><p>Отправителя агностик - не важно кто отправляет информацию которая вам нужна. Нас не ваолнует где это сервис находится, какой его адрес, какой порт подключения&#8230;&#8203;</p></li><li><p>Получателя агностик - нам не важно кто наши читатели, сколько их и откуда они подуключились.</p></li><li><p>А вот сколько партиций у кластера, все таки это уже устаревший консерн. Тут нас уже волнует какой уровень репликации данных мы хотим использовать.</p></li><li><p>О безопасности, только идентифицируй себя. NATS крайне сильный и обеспокоен безопасностью и поддерживает все необходимое, что бы обезопасить инфраструктуру.</p></li><li><p>Нас не беспокоит даже находятся ли сервисы в онлайне в данный момент времени (JetStream)</p></li><li><p>Мы получаем право выбирать какоу уровень гарантий качества нам неоходим изходя из наших потребностей.</p></li><li><p>Отказоустойчивость</p></li><li><p>Отказ от безпокойства за топологию это интересный момент, т.к. есть определенные неюансы, но на высоком уровне - вы можете отправлять сообщения в любом EDGE локации и ваше сообщение найдет адресата даже через сеть кластеров.</p></li></ul></div></aside></div></section></section>
<section><section id="_overview" data-autoslide="30000"><h2>Overview</h2><div class="slide-content"><div class="ulist"><ul><li><p>Functionality</p></li><li><p>Connectivity</p></li><li><p>Deployment Architectures</p></li><li><p>Security</p></li></ul></div><aside class="notes"><div class="paragraph"><p>Давайте взлянем на функциональные возможности, сопособы подключения, архитектурных топологий и безопасности.</p></div></aside></div></section><section id="_functionality" data-autoslide="30000"><h2>Functionality</h2><div class="slide-content"><div class="ulist"><ul><li><p>Core</p></li><li><p>JetStream</p></li></ul></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Streaming STAN protocol is  <strong><strong>Obsolete</strong></strong> and often appear as legacy documentation page for some developers google offers</td></tr></table></div>
<aside class="notes"><div class="paragraph"><p>С точки зрения функциональных возможностей следует разделять ЯДРО и JetStream.</p></div>
<div class="paragraph"><p>Раньше был еще STAN протокол, который стремился повысить уровень гарантий доставки. Это протокол оказался не таким удачным и команда поспешила заменить его более надежным RAFT протоколом.
Когда мы говорим о стриминге, мы де-факто имеем ввиду JetStream! Прошу это помнить!</p></div>
<div class="paragraph"><p>Ядро - представляет базовый функционал, который изначально был разработал и за что мы все полюбили NATS</p></div>
<div class="paragraph"><p>Джет Стриминг - новый функционал, который расширил возможности, дав нам альтернативу Apache Kafka, которую в первую очередь крайне легко поддерживать и обслуживать.</p></div></aside></div></section><section id="_connectivity_1" data-autoslide="30000"><h2>Connectivity <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="ulist"><ul><li><p>NATS plain</p></li><li><p>TLS encrypted NATS connections</p></li><li><p>MQTT <sup class="footnote">[<span class="footnote" title="View footnote.">2</span>]</sup></p></li><li><p>WebSocket <sup class="footnote">[<span class="footnote" title="View footnote.">3</span>]</sup></p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Подключиться к NATS можно по обычному или защищенному TLS подключению, а так же MQTT протокол широко распространенный в IoT решениях и WebSocket, который в своем представлении не нуждается.</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/nats-concepts/connectivity" class="bare">https://docs.nats.io/nats-concepts/connectivity</a></div><div class="footnote">2. <a href="https://docs.nats.io/running-a-nats-service/configuration/mqtt" class="bare">https://docs.nats.io/running-a-nats-service/configuration/mqtt</a></div><div class="footnote">3. <a href="https://docs.nats.io/running-a-nats-service/configuration/websocket" class="bare">https://docs.nats.io/running-a-nats-service/configuration/websocket</a></div></div></section><section id="_deployment_architectures_1" data-autoslide="120000"><h2>Deployment Architectures <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="ulist"><ul><li><p>Single</p></li><li><p>Cluster <sup class="footnote">[<span class="footnote" title="View footnote.">2</span>]</sup></p></li><li><p>Super-cluster</p><div class="ulist"><ul><li><p>Gateway cluster propagation protocol <sup class="footnote">[<span class="footnote" title="View footnote.">3</span>]</sup></p></li><li><p>Leaf message propagation Protocol <sup class="footnote">[<span class="footnote" title="View footnote.">4</span>]</sup></p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Как способ разворачивания, может быть развернута как <code>single node</code>, что не HA, в режиме кластера, сурер-кластер GateWay и Leaf протокол, который мы выбрали для построения нашего супер-кластера.</p></div>
<div class="ulist"><ul><li><p>Single - исключительно дев. окружение самого разработчика</p></li><li><p>Cluster - HA deployment, обычно с 3я нодами, повышает доступность и пропускную способность</p></li><li><p>Super-cluster</p><div class="ulist"><ul><li><p>Gateway - обьединяет несколько кластеров в полную сетку. Кластеры используются для обьединения node, в то время GW - для обьединения кластеров. Архитектурная цель протокола: Disaster Recovery</p></li><li><p>Leaf - расширяет существующую NATS систему в любом размере. Прозрачно перенаправляют сообщения с локальных клиентво к одной или больше удаленным системам и обратно.</p></li></ul></div></li></ul></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/nats-concepts/service_infrastructure/adaptive_edge_deployment" class="bare">https://docs.nats.io/nats-concepts/service_infrastructure/adaptive_edge_deployment</a></div><div class="footnote">2. <a href="https://docs.nats.io/running-a-nats-service/configuration/clustering" class="bare">https://docs.nats.io/running-a-nats-service/configuration/clustering</a></div><div class="footnote">3. <a href="https://docs.nats.io/running-a-nats-service/configuration/gateways" class="bare">https://docs.nats.io/running-a-nats-service/configuration/gateways</a></div><div class="footnote">4. <a href="https://docs.nats.io/running-a-nats-service/configuration/leafnodes" class="bare">https://docs.nats.io/running-a-nats-service/configuration/leafnodes</a></div></div></section><section id="_security_1" data-autoslide="180000"><h2>Security <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="ulist"><ul><li><p>Token</p></li><li><p>User/Password</p></li><li><p>TLS auth</p></li><li><p>NKeys</p></li><li><p>JWT</p></li></ul></div>
<aside class="notes"><div class="paragraph"><div class="title">Безопасность</div><p>Важно понимать разницу между аккаунт и пользователь. Аккаунт - это просто субсет пользователей с рязом высокоуровневых различий.</p></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>Accounts allow the grouping of clients, isolating them from clients in other accounts, thus enabling multi-tenancy in the server. With accounts, the subject space is not globally shared, greatly simplifying the messaging environment. Instead of devising complicated subject name carving patterns, clients can use short subjects without explicit authorization rules. System Events are an example of this isolation at work.</p></div></blockquote></div>
<div class="paragraph"><p>Аккаунт строго разделяется на системный и обычный. Так же аккаунт обязательно должен иметь включенную опцию <strong>jetstream</strong>, без нее все пользователи будут использовать только CORE функционал</p></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa fa-exclamation-circle" title="Important"></i></td><td class="content">Jetstream аккаунт не может быть системным.</td></tr></table></div>
<div class="paragraph"><p>У нас принята конвенция использовать 2 вида аккаунтов: <code>SYS</code> и <code>ACC</code></p></div>
<div class="paragraph"><p>Про методы аутентификации:</p></div>
<div class="paragraph"><div class="title">Token</div><p>Это единый токен для подключения. Для авторизации используется поле <code>user</code> у пользователя нет ограничений, но он принадлежит не системному аккаунту.</p></div>
<div class="paragraph"><div class="title">User/Password</div><p>Тут все просто. Это очень удобный механизм, т.к. позволяет легко настраивать права выбранных пользователей. Каждый пользователь может быть изолирован даже по типу подключения:</p></div>
<div class="paragraph"><div class="title">TLS auth</div><p>Клиент предоставляет сертификат подписанный рутовым сертификатом установленным конкретному кластеру. Мапинг пользователей осуществялется через данные указанные при регистрации пользователя.</p></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>Subject Alternative Name (SAN) maps to a user. It will search all email addresses first, then all DNS names. If no user could be found, it will try the certificate subject.</p></div></blockquote></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code>Certificate:
...
        X509v3 extensions:
            X509v3 Subject Alternative Name:
                DNS:localhost, IP Address:0:0:0:0:0:0:0:1, email:email@localhost
            X509v3 Extended Key Usage:
                TLS Web Client Authentication
...</code></pre></div></div>
<div class="paragraph"><p>Можно использовать RFC 2253 Distinguished Names (распределенные имена)  синтаксис описать пользователя относящегося с предметом сервтификата</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">authorization {
  users = [
    {user: "OU=testuser@MacBook-Pro.local (Test User),O=mkcert development certificate"}
  ]
}</code></pre></div></div>
<div class="paragraph"><div class="title">NKeys</div><p>Современная система публичной сигнатуры ключа основанной на Ed25519. Позволяет идентифицировать пользователя без хранения или видения приватного ключа.</p></div>
<div class="paragraph"><p>Настраивается намного легче, т.к. на сервере мы указываем публичный хэш ключа и далее его уже привязываем к группе прав.</p></div>
<div class="paragraph"><p>Тут по прежнему нам нужен приватный ключ для клиента, но на стороне сервера - только приватный ключ, что упрощает обслуживание.</p></div>
<div class="paragraph"><div class="title">JWT</div><p>Открытый стандарт RFC7519 метод для безопасного предоставления запросов между двумя распределенными частями.</p></div>
<div class="paragraph"><p>Подпись осуществляется через Ed25519 алгоритм. Все <code>Issuer</code> и <code>Subject</code> поля ключи - публичные NKEY которые.</p></div>
<div class="paragraph"><p><code>Issuer</code> и <code>Subject</code> - залинкованы на  следующие роли:</p></div>
<div class="ulist"><ul><li><p>Operators</p></li><li><p>Accounts</p></li><li><p>Users</p></li></ul></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/running-a-nats-service/configuration/securing_nats/auth_intro" class="bare">https://docs.nats.io/running-a-nats-service/configuration/securing_nats/auth_intro</a></div></div></section></section>
<section id="_quality_of_service_qos_1_2" data-autoslide="120000"><h2>Quality of service (QoS) <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup> <sup class="footnote">[<span class="footnote" title="View footnote.">2</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>A.K.A: Delivery guarantees or “delivery modes”</p></div>
<div class="paragraph"><p><a href="https://docs.nats.io/nats-concepts/overview/compare-nats">NATS comparison</a></p></div>
<div class="paragraph"><p>Developer should be aware about quality of delivery between NATS components to achieve desired goal.</p></div>
<table class="tableblock frame-sides grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">QoS</th><th class="tableblock halign-left valign-top">NATS component</th><th class="tableblock halign-left valign-top">Better for</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">At most once, QoS(0)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Core NATS</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Inviable data, events quickly superseded or high rate messaging</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">At-least, QoS(1)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JetStream (Stream+Consumer configuration)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Transaction processing, most forms of chat messaging, and remote command processing</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Exactly once, QoS(2)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JetStream: Producer: Message Deduplication Consumer: double ask</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Subscribers must receive the message only once.</p></td></tr></table>
<div class="paragraph"><p>Also always build additional reliability into your client applications yourself with proven and scalable reference designs such as acks and sequence numbers.</p></div>
<aside class="notes"><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Определяет как сильно MQ обрабатывает доставку сообщений. Каждый уровень гарантии это своеобразный компромис между скоростью и уверенностью в обработанном сообщении.
С каждым уровнем система требует больших проверкок и подтверждений для гарантии, что сообщение было обработано.
Что влияет на пропусную способность.</td></tr></table></div>
<div class="paragraph"><p>Понимание гарантии доставки крайне важные при проектировани IPC. И может выбирать между пропускной способность или гарантией отправки сообщения.</p></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Команда разработчиков должна понимать разницу и уметь правильно выбрать необходимый уровень качества доставки.</td></tr></table></div>
<div class="paragraph"><p>Для принятия решения важно анализировать бизнес требования функционала:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Насколько ценно сообщение?</p></li><li><p>Можем мы его потерять?</p></li><li><p>Что делать когда сообщение было утеряно?</p></li><li><p>Каие действия при системных ошибках следует предпринимать отправителю и/или подписчику?</p></li></ol></div>
<div class="paragraph"><div class="title">At most once (QoS 0)</div><p>В лучшем случае - отправит. Клиент не может знать хоть кто-то прочитает сообщение или нет! Еще называется “best-effort”</p></div>
<div class="paragraph"><p>Если никто не слушает subject или не активен в момент отправки сообщения - сообщение не будет доставлено.</p></div>
<div class="paragraph"><p>Такой же уровень гарантии предоставляет TCP/IP.</p></div>
<div class="paragraph"><p>Ядро отправляет и забывает сообщение. Он держит сообщения только в памяти и никогда не сохраняет их на диск.</p></div>
<div class="paragraph"><p>Обладает высокой пропускной способностью, т.к. накладные расходы это пропускная способность сети и CPU системы.</p></div>
<div class="paragraph"><div class="title">At-least once (QoS 1)</div><p>Клиент получает гарантию, что его сообщение будет сохранено.
На этом уровне гарантии клиент получает больше возможностей для отслеживания состояния его сообщения: если сообщение не будет отправлено он будет знать, что сообщение не было сохранено в стрим стор и нужно предпринять меры.</p></div>
<div class="paragraph"><div class="title">exactly once QoS (QoS 2)</div><p>Ideal when message rates are fairly low and where latency is not a primary concern.</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/nats-concepts/what-is-nats" class="bare">https://docs.nats.io/nats-concepts/what-is-nats</a></div><div class="footnote">2. <a href="https://developers.cloudflare.com/pub-sub/learning/delivery-guarantees" class="bare">https://developers.cloudflare.com/pub-sub/learning/delivery-guarantees</a></div></div></section>
<section id="_nats_concept" data-autoslide="30000"><h2>NATS concept</h2><div class="slide-content"><div class="ulist"><ul><li><p>Subject-Based Messaging</p></li><li><p>Core</p></li><li><p>JetStream</p></li><li><p>Subject Mapping and Partitioning</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Давайте поговорим об овновных концепта НАТС:</p></div>
<div class="ulist"><ul><li><p>тематических сообщений</p></li><li><p>ядре</p></li><li><p>стриминг системе</p></li><li><p>ии тематической маршрутизации и пепееаправлении</p></li></ul></div></aside></div></section>
<section id="_subject_based_messaging" data-autoslide="60000"><h2>Subject-Based Messaging</h2><div class="slide-content"><div class="paragraph"><p><code>Subject</code> - fundamental entity of NATS at all. In <code>Kafka</code>, <code>NSQ</code>, <code>RabbitMQ</code> - "topic" naming convention is used.</p></div>
<div class="paragraph"><p><span class="image"><img src="images/msgsvg2.svg" alt="msgsvg2"></span></p></div>
<div class="paragraph"><p>Represent case seinsitive string with one or more words <code>[a-zA-Z]</code>  with dot ('.')  separator.</p></div>
<div class="paragraph"><p>One more thing - where is <strong>Wilecards</strong>: "*" or "&gt;"</p></div>
<aside class="notes"><div class="paragraph"><p>Тема/Обьект/Subject - фундаментальная сущьность NATS. В Кафке, NSQ или RabbitMQ - имеет имя "topic"</p></div>
<div class="paragraph"><p>Представляет собой строку, слова в которой разделены точкой. Важно, что САБЖ чувствителен к регистру и состоит из букв и цифр.</p></div>
<div class="paragraph"><p>Слова САБЖА разделенные точкой создают своеобразную иерархию.</p></div>
<div class="paragraph"><p>Важную роль играют сец. символы - <strong>*</strong> и <strong>&gt;</strong></p></div>
<div class="ulist"><ul><li><p>- заменяет только одно слово, в то время &gt; - заменяет все правее ее, и находится в конце, обычно. &gt; можно использовать,
к примеру, как систему мониторинга или аудита безопасности. Если подписаться на САБЖ включаюзщий только &gt; можно получать все сообщения из системы.
Это можно обойти системой ограничений.</p></li></ul></div>
<div class="paragraph"><p>Спец. символы могут встречаться несколько раз <code><strong>.</strong>.east.&gt;</code></p></div>
<div class="paragraph"><p>Обратите внимание на пример, он хорошо показывает кто из подписчиков получает сообщение[30 sec timeout]</p></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>ЕСТЬ ЛИ ВОПРОСЫ?</p></div></blockquote></div></aside></div></section>
<section><section id="_core" data-autoslide="60000"><h2>Core</h2><div class="slide-content"><div class="paragraph"><p>Basic functionality which provide StateLess functionality with QoS tear 0 -  <strong>At most once</strong></p></div><div class="ulist"><ul><li><p>Publish-Subscribe</p></li><li><p>Request-Reply</p></li><li><p>Queue Groups</p></li></ul></div><aside class="notes"><div class="paragraph"><p>Я хочу сразу оговорить, что есть CORE функционал и это легаси часть NATS вполне жизнеспособна т.к. дает нам <strong>AT most once</strong> гарантию доставки.
Ей не нужно дисковое хранилище, она крайне быстра т.к. все что нужно ей это в момент получения запроса отправить всем кто подписан сообщение.</p></div>
<div class="paragraph"><p>С JetStream появилось несколько особенностей архитектуры, с которой многие разработчики путаются. И мне хочется закрыть это недопонимания.</p></div>
<div class="paragraph"><p>Важно понимать, что JetStream расширяет возможности NATS новым функционалом и это решать разработчику, какой именно механизм ему стоит исползовать.</p></div></aside></div></section><section id="_publish_subscribe_1" data-autoslide="60000"><h2>Publish-Subscribe <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>NATS implements a publish-subscribe message distribution model for one-to-many (Fan-Out) communication.</p></div>
<div class="paragraph"><p><span class="image"><img src="images/pub-sub.svg" alt="pub sub"></span></p></div>
<div class="olist arabic"><div class="title">Message</div><ol class="arabic"><li><p>subject</p></li><li><p>payload</p></li><li><p>headers</p></li><li><p>reply (opt)</p></li></ol></div>
<div class="paragraph"><p>Message size: <strong>1Mb</strong> by default, recommend up to <strong>8Mb</strong>, can be increased to <strong>64Mb</strong></p></div>
<aside class="notes"><div class="paragraph"><p>Класическая модель Pub-Sub реализовывает модель распределения - Один ко многим, так же это архитектурный патерн - Fan-Out.</p></div>
<div class="paragraph"><p>Каждый кто подписан на сообщение и находится в подключенном состоянии получит сообщение.</p></div>
<div class="paragraph"><p>Важно помнить о размере сообщения, которое по умолчанию имеет ограничение 1Мб, и которое можно расширить до 64, но рекомендуется не больше 8.</p></div>
<div class="paragraph"><p>Самый на мое усмотрение элемент сообщения - Headers, которые появились в v2.2 и дали возможность использова трасировку,
без обязательного помещения информации в тело сообщения. Так же, опциональное поле - reply позволяет написать свою реализацию <strong>Request/Reply</strong> функционала.</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://www.youtube.com/watch?v=jLTVhP08Tq0" class="bare">https://www.youtube.com/watch?v=jLTVhP08Tq0</a></div></div></section><section id="_request_reply" data-autoslide="180000"><h2>Request-Reply</h2><div class="slide-content"><div class="paragraph"><p>Request/Reply approach - Remote procedure call (RPC) via MQ NATS system. This mean it&#8217;s blocking operation based on pub-sub functionality.</p></div>
<div class="paragraph"><p><span class="image"><img src="images/req_reply.svg" alt="req reply"></span></p></div>
<div class="ulist"><ul><li><p>Publisher put <code>INBOX</code> tmp subject into reply field with further waiting respond on it</p></li></ul></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa fa-exclamation-circle" title="Important"></i></td><td class="content">Producers should use <strong>drain before exiting</strong> processing for waiting unanswered messages</td></tr></table></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content"><div class="paragraph"><p>Remember One-to-Many. This mean all subscriber will get this message. In horizontal scale it can bring to unpredictable behaviour</p></div></td></tr></table></div>
<aside class="notes"><div class="paragraph"><p>У меня этот функционал вызывает спорные чувства.</p></div>
<div class="paragraph"><p>С одной стороны это Киллер Фича.</p></div>
<div class="paragraph"><p>Она решает волпросы сервис-дискавери системы, легка в использовании, не требует массы другого функционала для балансировки как в класических протоколах RPC.</p></div>
<div class="paragraph"><p>Я даже считаю, что использование NATS как-то даже повлияло на его феноменальный рост.</p></div>
<div class="paragraph"><p>Но с точки зрения архитектуры - это MQ система, и реализаций - сахарное решение и нужно даже сказать, довольно интересное.</p></div>
<div class="paragraph"><p>Для PIN-UP может даже оказаться, что эта система станет чуть-ли не основной :) Сейчас мы работаем еще над одной системой, которая должна нам дать и сервис-дискавери, и возможность балансироваки http, grpc между сервисам - и это не K8S, над которым мы так же работаем :)</p></div>
<div class="paragraph"><p>НО, давайте посмотрим как же работает Request/Reply:</p></div>
<div class="paragraph"><p>Это блокирующая операцию, которая задейсвует подписчиком сперва отправку сообщения и далее - подписку на сообщение, которое он поместил в поле REPLY.</p></div>
<div class="paragraph"><p>Есть важные моменты:</p></div>
<div class="ulist"><ul><li><p>Продюсер должен реализовать в обязательном порядке - drain логику</p></li></ul></div>
<div class="paragraph"><p>которая просто будет ждать какое-то время все незакрытые хэндлеры. Это особо важно в наших немасштабируемых и in-memory processing системах. Т.к. время дрэйна может быть недостаточно при 100500 рутингах</p></div>
<div class="ulist"><ul><li><p>Еще важная проблема - это несовсем четкая документация, которая с одной стороны призывает к легкой масштабируемости -</p></li></ul></div>
<div class="paragraph"><p>мол, не парьтесь, система через динамические очереди может гарантировать, что 1 сообщение получит только одно подключение.
И в тоже время, хвастается на то, что запрос могут обрабатывать несколько подписчиков.</p></div>
<div class="paragraph"><p>Тут многие могут запутаться.</p></div>
<div class="paragraph"><p>По умолчанию, это так и работает - правило ОДИН-КО-МНОГИМ тут так же работает, никто его не отменял. Поэтому замасштабированные подписчики ВСЕ получат запрос реплики, это может привести к МИЛЛИОНУ проблем.</p></div>
<div class="paragraph"><p>По этому важно, понимать все возможности NATS и как их использовать!</p></div>
<div class="paragraph"><p>НАДЕЮСЬ я тут вас уже заинтересовал и вам уже интересно!</p></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>Поднимите руку, кто знает, как решить вопрос с гарантией ОДИН-К-ОДНОМУ ?</p></div></blockquote></div></aside></div></section><section id="_queue_groups_1" data-autoslide="120000"><h2>Queue Groups <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>Combine one or more consumer into group (like Load Balancer) where only one random member get a message. Group have the same naming convention as subject.</p></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa fa-exclamation-circle" title="Important"></i></td><td class="content">Queue subscribers are ideal for scaling services.</td></tr></table></div>
<div class="paragraph"><p><span class="image"><img src="images/groups.svg" alt="groups"></span></p></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">RabbitMQ, Kafka has the same naming concept - "queue" while NSQ - "chanel"</td></tr></table></div>
<aside class="notes"><div class="paragraph"><p>Семантически группа - имеет такое же название в RabbitMQ и Kafka. Хотя в NSQ имеет имя - channel.</p></div>
<div class="paragraph"><p>Она комбинирует один или более подписчиков в единую группу, так называемый лоад балансер. Сама группа имеет те же требования к неймингу, что и subject.</p></div>
<div class="paragraph"><p>Груповая очередь - важный функционал для микро-сервиса. Без нее невозможно реализовать горизонтальное масштабирование.</p></div>
<div class="paragraph"><p>Т.к. обычная бизнес задача сервиса - обрабатывать разово каждое пришедшее в сервис сообщения.</p></div>
<div class="paragraph"><p>А мы уже знаем, что по умолчанию модель доставки ОДИН-КО-МНОГИМ.</p></div>
<div class="paragraph"><p>Но наш сервис должен быть масштабируемым!!!</p></div>
<div class="paragraph"><p>Разработчик при подписке должен четко понимать какое требуется поведение его приложение при масштабировании!</p></div>
<div class="paragraph"><p>Непонимание этого приведет к КАТАСТРОФИЧЕСКИМ последсвиям, особенно в промышленной среде, когда репликация может быть расширена и на 20 и больше копий,
в то время как на DEV или STAGE среде это приложение может быть всего в одном экземпляре.</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/nats-concepts/core-nats/queue" class="bare">https://docs.nats.io/nats-concepts/core-nats/queue</a></div></div></section><section id="_when_to_use_core_nats_1" data-autoslide="60000"><h2>When to use Core NATS <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>Using core NATS is ideal for the fast request path for scalable services where there is tolerance for message loss or when applications themselves handle message delivery guarantees.</p></div></blockquote></div>
<div class="openblock text-left"><div class="content"><div class="paragraph"><p>These include:</p></div>
<div class="ulist"><ul><li><p>Service patterns where there is a tightly coupled request-reply where app handle error cases upon timeout</p></li></ul></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Relying on a messaging system to resend here is
considered an <strong>anti-pattern</strong></td></tr></table></div>
<div class="ulist"><ul><li><p>Where only the last message received is important and new messages will
be received frequently enough for applications to tolerate a lost message.</p></li><li><p>Message TTL is low</p></li><li><p>The expected consumer set for a message is available a-priori and consumers
are expected to be live. The request-reply pattern works well here or
consumers can send an application level acknowledgement.</p></li></ul></div></div></div>
<aside class="notes"><div class="paragraph"><p>Когда же можно использовать функционал ЯДРА?</p></div>
<div class="paragraph"><p>Кор функционал идеален для быстрых запросов для масштабируемых сервисов с допуском потери сообщения или  обеспечения надежности на уровне приложения.</p></div>
<div class="paragraph"><p>Это включает:</p></div>
<div class="ulist"><ul><li><p>Сервисный патерн "Тесной-связанности" - Request/Reply - где очевидна потеря сообщения и приложение может отслеживать переотправку сообщения
В нашей микросервисной архитектуре, это ЗЛО, с которым мы должны бороться и рассматривать его использование, только в крайних случаях.</p></li></ul></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Надеяться на то, что NATS будет заниматься переотправкой - это анти-патерн!</td></tr></table></div>
<div class="ulist text-left"><ul><li><p>Когда важно только последнее сообщение и новые сообщения отправляются довольно часто, что бы приложения мерилось с потерей сообщений.</p></li><li><p>Время жизни сообщения мало - данные быстро деградируют или быстро становятся не актуальными.
Это могут быть поток рыночных котировок, большой обмен сообщениями в системе контроля сервисами или телеметрия оборудования.</p></li><li><p>Потребитель живет а-приори и ожидается, что консьюмер живет.
Я расцениваю это как анти-патерн - т.к. <code>все что может произойти, произойдет</code>, исключение - распил монолита. Первая стадия - изоляция компонентов через брокер, тут наш сервис является и подписчиком и продюсером.</p></li></ul></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/using-nats/developer/develop_jetstream#when-to-use-core-nats" class="bare">https://docs.nats.io/using-nats/developer/develop_jetstream#when-to-use-core-nats</a></div></div></section></section>
<section><section id="_jetstream" data-autoslide="60000"><h2>JetStream</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>NATS has a built-in distributed persistence system called JetStream which enables new functionalities and higher qualities of service on top of the base 'Core NATS' functionalities and qualities of service.</p></div></blockquote></div><aside class="notes"><div class="paragraph"><p>JetStream</p></div>
<div class="paragraph"><p>Протокол стан не дал желаемого результата, там было очень много проблем, однако, NATS хотел предложить облачной аудитории именно облачную систему событи, но с более высокими гарантиями доставки.</p></div>
<div class="paragraph"><p>Он разделяет потребление и отправку сообщение, предоставляя большое разнообризие возможностей потребления одного стрима.</p></div>
<div class="paragraph"><p>Состоит из стрим сервера, которых хранит данные и сервера потребителя, которому эти сохраненные данные предоставляются.</p></div>
<div class="paragraph"><p>Как стримы так и консьюмеры могут быть созданы заранее (что мы и требует с нашим GitOps подходом) и независимо. Что предоставляет гибкость в балансе между производительностью и надежность.</p></div></aside></div></section><section id="_goals_1" data-autoslide="60000"><h2>Goals <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>JetStream was developed with the following goals in mind</p></div>
<div class="ulist"><ul><li class="fragment"><p>The system must be easy to configure and operate and be observable.</p></li><li class="fragment"><p>The system must be secure and operate well with NATS 2.0 security models.</p></li><li class="fragment"><p>The system must scale horizontally and be applicable to a high ingestion rate.</p></li><li class="fragment"><p>The system must support multiple use cases.</p></li><li class="fragment"><p>The system must self-heal and always be available.</p></li><li class="fragment"><p>The system must have an API that is closer to core NATS.</p></li><li class="fragment"><p>The system must allow NATS messages to be part of a stream as desired.</p></li><li class="fragment"><p>The system must display payload agnostic behavior.</p></li><li class="fragment"><p>The system must not have third party dependencies.</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Какие же цели создатели возложили на свое детище,</p></div>
<div class="ulist"><ul><li><p>Система должна быть проста в настройке, обслуживании и мониторинге</p></li><li><p>Система должна соответсвовать стандарту безопасности NATS 2.0</p></li><li><p>Система должна горизонтально масштабироваться и быть готовой к высокой пропускной способности</p></li><li><p>Должна поддерживать разнообразные сценарии использования</p></li><li><p>Система должна быть HA, что включает и само-лечение</p></li><li><p>API должно быть близкий к CORE</p></li><li><p>CORE сообщения должны быть частью системы стриминга</p></li><li><p>Независимая модель типов передачи данных</p></li><li><p>Без внещних зависимостей от других продуктов</p></li></ul></div></aside></div><div class="footnotes"><div class="footnote">1. A footnote on introduction?!</div></div></section><section id="_raft_1_2" class="columns wrap" data-autoslide="180000"><h2>RAFT <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup> <sup class="footnote">[<span class="footnote" title="View footnote.">2</span>]</sup></h2><div class="slide-content"><div class="openblock column is-one-third has-text-justified"><div class="content"><div class="paragraph"><p><strong>Meta Group</strong> - all servers join the Meta Group and the JetStream API is managed by this group. A leader is elected and this owns the API and takes care of server placement.</p></div></div></div>
<div class="openblock column is-one-third has-text-justified"><div class="content"><div class="paragraph"><p><strong>Stream Group</strong> - each Stream creates a RAFT group, this group synchronizes state and data between its members. The elected leader handles ACKs and so forth, if there is no leader the stream will not accept messages.</p></div></div></div>
<div class="openblock column is-one-third has-text-justified"><div class="content"><div class="paragraph"><p><strong>Consumer Group</strong> - each Consumer creates a RAFT group, this group synchronizes consumer state between its members. The group will live on the machines where the Stream Group is and handle consumption ACKs etc. Each Consumer will have their own group.</p></div></div></div>
<div class="openblock column is-one-third"><div class="content"><div class="imageblock"><img src="images/meta_group.png" alt="meta group" width="40%"></div></div></div>
<div class="openblock column is-one-third"><div class="content"><div class="imageblock"><img src="images/stream_group.png" alt="stream group" width="40%"></div></div></div>
<div class="openblock column is-one-third"><div class="content"><div class="imageblock"><img src="images/consumer_group.png" alt="consumer group" width="40%"></div></div></div>
<aside class="notes"><div class="paragraph"><p>Для понимания работы системы, думаю важно понимать сам протокол RAFT который используется JetStream.</p></div>
<div class="paragraph"><p>Сам протокол оптимизирован, т.к. обычный протокол использует большое количество трафика.</p></div>
<div class="paragraph"><p>Разработчики скрестили сообщения репликации с протоколом, который обеспечивает консенсус нод.</p></div>
<div class="paragraph"><p>Что такое консенсус? RAFT протокол это разновидность патерна мастера или лидера в распределенной системе, когда системно-важные операции требуется выполнять единоразово.</p></div>
<div class="paragraph"><p>Этот протокол позволяет отслеживать доступность остальных участников кластера и имеет ряд процедур само-восстановления, которые позволяют продолжать выполнять задачи, когда один участник или несколко были утеряны.</p></div>
<div class="paragraph"><p>Формула консолидации или минимальное количество живых нод:  1/2 cluster size + 1. Иными словами, если кластер из 3 нод потеряет 1  - система будет работать дальше.</p></div>
<div class="paragraph"><p>Рекомендуется: 3 или 5 нодный кластер, в случае 5 нод - может отпасть 2 для продолжения работоспособности, больше нод - генерируют очень большое количество трафика.</p></div>
<div class="paragraph"><p>Так же стоит понимать, что чем больше реплик стрима - тем дольше мы будем получать подтверждение!</p></div>
<div class="paragraph"><p>И тут важно обратить внимание уже на то, что у ДжетСтрима не простой протокол рафта.</p></div>
<div class="paragraph"><p>Точнее, каждый стрим имеет свою отдельную группу RAFT со своим лидером!!</p></div>
<div class="paragraph"><p>Более того, каждый консьюмер, точно так же имеет отдельную группу, но живут они на серверах где разместились реплики!</p></div>
<div class="paragraph"><p>Так достигается высокое распределение нагрузки между нодами, в случае большого количества стримов и консьюмеров и они не будут перегружать друг друга.</p></div>
<div class="paragraph"><p>Существует еще одина дополнительная группа - META. ВСЕ сервера к ней подключаются и она заведует JS API и размещении серверов.  Тут я могу добавить предположение - что эта группа выбирает на каких нодах создать стрим, но вот как она принимает участие в самой работе сообщений, тут вопрос пока у меня стоит открытым.</p></div>
<div class="paragraph"><p>В дополнении, я рекомендую вам посетить ресурс - <a href="https://raft.github.io/" class="bare">https://raft.github.io/</a> который крайне наглядно продемонстрирует работу этого протокола.</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering" class="bare">https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering</a></div><div class="footnote">2. <a href="https://raft.github.io/" class="bare">https://raft.github.io/</a></div></div></section><section id="_streams" data-autoslide="250000"><h2>Streams</h2><div class="slide-content"><div class="imageblock"><img src="images/streams-and-consumers-75p.png" alt="streams and consumers 75p"></div>
<aside class="notes"><div class="paragraph"><p>И что же такое стрим?</p></div>
<div class="paragraph"><p>Это хранилище сообщений, где каждое ранилище определяет какие сообщения в нем хранить и какие лимиты хранения - длительность, размер или актуальность.</p></div>
<div class="paragraph"><p>Стрим может потреблять как обычные сообщения из ЯДРА, если не трубется подтверждение, так и через протокол  JS с блокирующей операцией о записи в стрим.</p></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Но&#8230;&#8203;. кажется, что-то тут не сходится? Уже сейчас, кто из вас использует стриминг и может возмутиться!</td></tr></table></div>
<div class="paragraph"><p>Эта информация у меня может получиться эмоциональной!</p></div>
<div class="paragraph"><p>Т.к. дизайн стрима противоречик как: Event Driven Designs и Event Modeling вместе взятым.</p></div>
<div class="paragraph"><p>Так что это значит?</p></div>
<div class="paragraph"><p>Сущьность продюсера - это консьюмер агностик.</p></div>
<div class="paragraph"><p>Продюсер являемся распространителем Доменных событий  и ОН несем информацию в свет, эта информация может потребляться совершенно разными способами и использоваться по разному.</p></div>
<div class="paragraph"><p>Это дает гибкость архитектуре. Это позволяет ее развивать независимо!</p></div>
<div class="paragraph"><p>К примеру, один раз написав сообщение при отправке "ставок", его могут читать как сервис аналитики, так и новые компоненты, которых даже еще не существует на момент создания отправки этого сообщения.</p></div>
<div class="paragraph"><p>И другим коммандам не нужно привлекать команду сервиса "ставок", что бы они им помогли наладить комуникацию, т.к. она едина и понятна.</p></div>
<div class="paragraph"><p>Благодаря единому хранилищу API и единой конвенции, каждая команда понимает, где находится находится эта документация и ВПРАВЕ ее использовать для своих целей.</p></div>
<div class="paragraph"><p>Такой подход даже сохраняет трафик сети - т.к. не требуется дублировать его. Потребитель прочитает сообщение и возьмет что ему нужно. Не нужно повторно отправляю и дублировать одну и ту же информацию.</p></div>
<div class="paragraph"><p>INFO: ПАУЗА</p></div>
<div class="paragraph"><p>Теперь возвращаемся еще раз к описанию стримов.</p></div>
<div class="paragraph"><p>Меня давно волновал вопрос о эффективности хранения данных в стриме!</p></div>
<div class="paragraph"><p>По факту, "можно же" создать ряд стримов, которые будут хранить одни и те же данные. Однако, нет - на низком уровне запрещено это делать, это я узнал совсем недавно!</p></div>
<div class="paragraph"><p>Итак, какие есть проблемы:</p></div>
<div class="paragraph"><p>1) Если продюсер хочем получить гарантию доставки в стрим - ему нужно знать имя стрима, что убирает агностичность отправки.
&gt; Мы можем использовать повышенную гарантию доставки, в случае разработки SAGA патернов внутри одного кластера, но не в Event Driven Design.
Но ВЫ должны задать вопрос - как поведут Leaf сообщения, в других кластерах, если там будут такие же подписки !</p></div>
<div class="paragraph"><p>2) Как мы можем использовать повышенный уровень доставки, в случае сообщений между кластерами?
Ответ: Event Driven не требует гарантии записи в стрим, это требуют SAGA патерны - оркестрация, в то время хореография - допускает.</p></div>
<div class="paragraph"><p>3) Нужен ли нам Exactly-once при отправке вообще?
Ответ: Если мы делаем дедубликацию на стороне сервиса - нет, при условии, при Event Driven  Design этого достаточно, при Saga - есть вопросы, т.к в этом случае мы понимаем конечный результат.</p></div>
<div class="paragraph"><p>Уффф&#8230;&#8203;</p></div>
<div class="paragraph"><p>Это очень тяжелая концепция, я даже подозреваю, у многи из вас появилось только больше вопросов или же вы хотите что-то дополнить?</p></div>
<div class="admonitionblock tip"><table><tr><td class="icon"><i class="fa fa-lightbulb-o" title="Tip"></i></td><td class="content">Давайте проведедм голосование в нашем телеграм боте!</td></tr></table></div></aside></div></section><section id="_functionalities_enabled_by_jetstream_1" data-autoslide="180000"><h2>Functionalities enabled by JetStream <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="ulist"><ul><li><p>Streaming: temporal decoupling between the publishers and subscribers</p></li><li><p>Replay policies</p></li><li><p>Retention policies and limits</p></li><li><p>Persistent distributed storage</p></li><li><p>Stream replication factor</p></li><li><p>Mirroring between streams</p></li><li><p>De-coupled flow control</p></li><li><p>Exactly once semantics</p></li></ul></div>
<aside class="notes"></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/nats-concepts/jetstream" class="bare">https://docs.nats.io/nats-concepts/jetstream</a></div></div></section><section id="_consumers"><h2>Consumers</h2></section><section id="_keyvalue_store"><h2>Key/Value Store</h2></section><section id="_object_store_1"><h2>Object Store <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>А вот это еще одна киллер-фича. Которая дает нам настоящее блочное хранилище - S3 в "простонародии".</p></div>
<div class="paragraph"><p>Она сейчас еще помечена как эксперимент и является частью функционала JetStream</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/nats-concepts/jetstream/obj_store" class="bare">https://docs.nats.io/nats-concepts/jetstream/obj_store</a></div></div></section><section id="_when_to_use_streaming_1"><h2>When to use streaming <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>Streaming is ideal when:</p></div>
<div class="ulist"><ul><li><p>A historical record of a stream is required. This is when a replay of data is required by a consumer.</p></li><li><p>The last message produced on a stream is required for initialization and the producer may be offline.</p></li><li><p>A-priori knowledge of consumers is not available, but consumers must receive messages. This is often a false assumption.</p></li><li><p>Data producers and consumers are highly decoupled. They may be online at different times and consumers must receive messages.</p></li><li><p>The data in messages being sent have a lifespan beyond that of the intended application lifespan.</p></li><li><p>Applications need to consume data at their own pace.</p></li><li><p>You want de-coupled flow control between the publishers and the consumers of the stream</p></li><li><p>You need 'exactly-once' quality of service with de-duplication of publications and double-acknowledged consumption</p></li></ul></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">that no assumptions should ever be made of who will receive and process data in the future, or for what purpose.</td></tr></table></div>
<aside class="notes"><div class="paragraph"><p>Давайте рассмотрим для чего сами разработчики рекомендуют использовать стриминг</p></div>
<div class="paragraph"><p>Стриминг идеален:</p></div>
<div class="ulist"><ul><li><p>Требуются исторические записи потока. Это когда консьюмер требует чтение исторических данных. Т.е. в начале когда команда не получила эту информацию и считает, что им не нужно чтение исторических данных, можно и TTL заюзать? А что делать когда появится?</p></li><li><p>Когда требуется последнее отправленное сообщение, а отправитель может быть оффлайн - это может быть просто JOBa, а возможно и нормальное архитектурная микросервисная практика - что сервисы падают и это нормально.</p></li><li><p>Мы не знаем о потребителях ничего, но знаем что они должны получать сообщения. Для меня это анти-патерн на основе EDA и EM. Философия Event Driven - агностичность! Есть читатель или нет - продюсера это не волнует.</p></li><li><p>Сильно разделенные продюсеры и консьюмеры - Могут находиться в сети в разное время.</p></li><li><p>Время жизни отправленного сообщение уходит далеко за существование самого сервиса. Тут намекают на serverless подход ну или опять же JOB/CRON патерн.</p></li><li><p>Приложения должны обрабатывать запросы в собсвенном темпе - в случае с At most once MQ очень зависить от общей мощности потребителей и из-за этого страдаем пропускная способность.
Эта важная MQ характеристика. Этого буфера раньше не было в NATS  (CORE) и из-за этого можно было считать его не полноценной MQ. Этот буфер позволяет не держать большой штат мощности, а гарантировать обработку ВСПЛЕСКА запросов! ВСЕ будут обработаны! ЭТО ОЧЕНЬ КРИТИЧНО ВАЖНО!</p></li><li><p>Требуется патерт - Flow Control, где важно управлять количеством паралельно отправляемых и получаемых сообзщений. Можно сказать, можно сделать что-то на подобие распределенного мастер патерна.</p></li><li><p>И конечно же де-дубликация отправленных сообщений и двойное подтверждение потребителями.</p></li></ul></div>
<div class="paragraph"><p>Хочется обобщить - БУФЕР и Гаратнии доставки!</p></div>
<div class="paragraph"><p>Это тяжелый раздел, все ли понятно, есть ли вопросы?</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/using-nats/developer/develop_jetstream#when-to-use-streaming" class="bare">https://docs.nats.io/using-nats/developer/develop_jetstream#when-to-use-streaming</a></div></div></section></section>
<section id="_subject_mapping_and_partitioning_1"><h2>Subject Mapping and Partitioning <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>v2.9 feature</p></div>
<div class="ulist"><ul><li><p>Reduced time and bandwidth for replication catch-up</p></li><li><p>Improved message distribution for multi-subscription pull consumers</p></li><li><p>Inactive threshold for durable consumers</p></li><li><p>GetLastMsg</p></li><li><p>AllowDirect, MirrorDirect
*</p></li><li><p>Message republishing</p></li></ul></div>
<div class="paragraph"><p><span class="image"><img src="images/pull-fetch-prior29.jpg" alt="pull fetch prior29"></span></p></div>
<hr>
<div class="paragraph"><p><span class="image"><img src="images/pull-fetch-29.jpg" alt="pull fetch 29"></span></p></div>
<hr>
<div class="paragraph"><p><span class="image"><img src="images/direct-get.jpg" alt="direct get"></span></p></div>
<aside class="notes"><div class="paragraph"><p>Версия v2.9 настолько большая, что для нее написали целую статью в блоге.</p></div>
<div class="paragraph"><p>И&#8230;&#8203; действительно, это так, тут есть много интересного</p></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">что go библиотека должна быть обновлена до  v1.1.17!</td></tr></table></div>
<div class="paragraph"><div class="title">Reduced time and bandwidth for replication catch-up</div><p>Я считаю, только ради этой фичи нужно задуматься о переходе на нее, хотя уже появился стабильная v2.9.2 и почему бы и нет.</p></div>
<div class="paragraph"><p>В реалиях продакшна, когда в стриме большие данные и поднимается нода, которой требуется наверстать все данные - алгоритм репликации может существенно повлиять на сетевую инфраструктуру, существенно деградирую сетевую пропускную способность.
В 2.9 появился параметр лимита пропускной способности - <code>jetstream.max_outstanding_catchup</code> а так же - компрессия!</p></div>
<div class="paragraph"><div class="title">Improved message distribution for multi-subscription pull consumers</div><p>Еще одна феноменальная фича, для уже актуально для горизонтально масштабируемых систем - на слайде я надеюсь вмем понятно преимущество, мне только не ясно почему так долго такой беспредел вообще был&#8230;&#8203; печально и радосно :)</p></div>
<div class="paragraph"><div class="title">Inactive threshold for durable consumers</div><p>Расширение параметра <code>InactiveThreshold</code>  не только на эфимерные консьюмеры, но и долговечные.</p></div>
<div class="paragraph"><p>Для тех кто не знает, что такое, эфимерный консьюмер - временные консьюмеры с ограниченным временем жизни. Чтобы его создать в клиенте вызываем  <code>SubscribeSync</code> в интерфейса JS:
Эфимерных консьюмеров - они у нас запрещены, т.к. мы стараемся контролирова декларативно всех потребителей.
Однако, возможно для некоторых задач это будет актуально и по этому, я считаю, что вы как минимум об это знать.</p></div>
<div class="paragraph"><p>За что отвечает библиотека клиента:</p></div>
<div class="ulist"><ul><li><p>Ищет патерны сабджектов в стримах</p></li><li><p>Создает безимянный консьюмер</p></li><li><p>И осуществлет подписку</p></li></ul></div>
<div class="paragraph"><div class="title">GetLastMsg</div><p>Client API Возможность получить последнее сообщение в стриме по сабджу</p></div>
<div class="paragraph"><div class="title">AllowDirect MirrorDirect</div><p>Стрим настройка позволяет выполнять GET операции в стриме не только лидером, но и репликами&#8230;&#8203;</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://nats.io/blog/nats-server-29-release/" class="bare">https://nats.io/blog/nats-server-29-release/</a></div></div></section>
<section><section id="_future_of_nats"><h2>Future of Nats</h2></section><section id="_release_2_9_1"><h2>Release 2.9 <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>context</p></div></div><div class="footnotes"><div class="footnote">1. <a href="https://nats.io/blog/nats-server-29-release" class="bare">https://nats.io/blog/nats-server-29-release</a></div></div></section><section id="_road_map"><h2>Road map</h2><div class="slide-content"><div class="imageblock"><img src="images/roadmap.png" alt="roadmap"></div></div></section></section>
<section id="_presentation_url"><h2>Presentation url</h2><div class="slide-content"><div class="paragraph"><p><span class="image"><img src="images/pres_url.png" alt="pres url" width="500"></span></p></div></div></section>
<section id="_contacts"><h2>Contacts</h2><div class="slide-content"><div class="paragraph"><p><span class="icon"><i class="fa fa-envelope fa-lg"></i></span> <a href="mailto:d.harupa@pin-up.team">d.harupa@pin-up.team</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-envelope fa-lg"></i></span> <a href="mailto:d7561985@gmail.com">d7561985@gmail.com</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-github fa-lg"></i></span> <a href="https://github.com/d7561985" class="bare">https://github.com/d7561985</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-linkedin fa-lg"></i></span> <a href="https://linkedin.com/in/dzmitry-harupa-332131137" class="bare">https://linkedin.com/in/dzmitry-harupa-332131137</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-instagram fa-lg"></i></span> dzmityinv</p></div></div></section>
<section id="_qa"><h2>Q/A</h2></section></div></div><script src="./reveal.js/dist/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: true,
  // Push each slide change to the browser history. Implies `hash: true`
  history: false,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: false,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 2700,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1920,
  height: 1080,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: './reveal.js/plugin/zoom/zoom.js', async: true, callback: function () { Reveal.registerPlugin(RevealZoom) } },
      { src: './reveal.js/plugin/notes/notes.js', async: true, callback: function () { Reveal.registerPlugin(RevealNotes) } }
  ],
});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1920, 1080)
});</script></body></html>