<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>NATS events and beyond</title><link rel="stylesheet" href="node_modules/reveal.js/dist/reset.css"><link rel="stylesheet" href="node_modules/reveal.js/dist/reveal.css"><link rel="stylesheet" href="node_modules/reveal.js/dist/theme/black.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* source blocks */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* auto-animate feature */
/* hide the scrollbar when auto-animating source blocks */
.reveal pre[data-auto-animate-target] {
  overflow: hidden;
}

.reveal pre[data-auto-animate-target] code {
  overflow: hidden;
}

/* add a min width to avoid horizontal shift on line numbers */
code.hljs .hljs-ln-line.hljs-ln-n {
  min-width: 1.25em;
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}

.byline {
  font-size:.8em
}
ul.byline {
  list-style-type: none;
}
ul.byline li + li {
  margin-top: 0.25em;
}
</style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/v4-shims.min.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title" data-transition-speed="fast"><h1>NATS events and beyond</h1><div class="preamble"><div class="paragraph"><p>Introduction for developers</p></div>
<div class="paragraph"><p>by Harupa Dzmitry &lt;<a href="mailto:d.harupa@pin-up.team">d.harupa@pin-up.team</a>&gt;</p></div>
<div class="paragraph"><p>@2022</p></div></div></section>
<section id="_about"><h2>About</h2><div class="slide-content"><div class="paragraph"><p>Something about me</p></div></div></section>
<section id="_agenda"><h2>Agenda</h2><div class="slide-content"><div class="ulist"><ul><li><p>NATS.(5 min)</p><div class="ulist"><ul><li><p>Subject-Based Messaging</p></li><li><p>Core</p></li><li><p>JetStream</p></li></ul></div></li><li><p>Pin-Up Infrastructure.(3 min)</p></li><li><p>Development</p><div class="ulist"><ul><li><p>D1</p></li><li><p>D2</p></li></ul></div></li><li><p>Conventions. (2 min)</p><div class="ulist"><ul><li><p>GO development guideline (7 min)</p></li><li><p>Service deployment + gitops. (5 min)</p></li></ul></div></li><li><p>Event driven architecture. (&lt;5 min)</p></li></ul></div></div></section>
<section><section id="_nats"><h2>NATS</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>message oriented middleware</p></div></blockquote></div><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content"><div class="title">With NATS, application developers can</div><div class="ulist"><ul><li><p>Effortlessly build distributed and scalable client-server applications.</p></li><li><p>Store and distribute data in realtime in a general manner. This can flexibly be achieved across various environments, languages, cloud providers and on-premises systems.</p></li></ul></div></td></tr></table></div><aside class="notes"><div class="paragraph"><p>Сами разработчики называют NATS: <code>сообщения-ориентированным посредником</code></p></div>
<div class="ulist"><ul><li><p>Возможно разрабатывать без особого труда распределенные и масштабируемые клиент-сервер приложения</p></li><li><p>Хранить и распространять данные в реальном времени в общем виде</p></li></ul></div></aside></div></section><section id="_features"><h2>Features</h2><div class="slide-content"><div class="ulist"><ul><li><p>At-least-once delivery and exactly once within a window</p></li><li><p>Store data and replay by time or sequence</p></li><li><p>Wildcard support</p></li><li><p>NATS 2.0 Security aware</p></li><li><p>Data at rest encryption (Version 2.2.3)</p></li><li><p>Cleanse specific messages (General Data Protection Regulation: GDPR)</p></li><li><p>Horizontal scalability</p></li><li><p>Persist Streams and replay via Consumers</p></li></ul></div></div></section><section id="_quality_of_service_qos_1_2"><h2>Quality of service (QoS) <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup> <sup class="footnote">[<span class="footnote" title="View footnote.">2</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>A.K.A: Delivery guarantees or “delivery modes”</p></div>
<div class="paragraph"><p>Developer should be aware about quality of delivery between NATS components to achieve desired goal.</p></div>
<table class="tableblock frame-sides grid-all" style="width:100%"><colgroup><col style="width:33.3333%"><col style="width:33.3333%"><col style="width:33.3334%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">QoS</th><th class="tableblock halign-left valign-top">NATS component</th><th class="tableblock halign-left valign-top">Better for</th></tr><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">At most once, QoS(0)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Core NATS</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Inviable data, events quickly superseded or high rate messaging</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">At-least, QoS(1)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JetStream (Stream+Consumer configuration)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Transaction processing, most forms of chat messaging, and remote command processing</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Exactly once, QoS(2)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">JetStream: Client: msgID, Consumer: DeliverPolicy + Flow control option</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Subscribers must receive the message only once.</p></td></tr></table>
<div class="paragraph"><p>Also always build additional reliability into your client applications yourself with proven and scalable reference designs such as acks and sequence numbers.</p></div>
<aside class="notes"><div class="admonitionblock note"><table><tr><td class="icon"><i class="fa fa-info-circle" title="Note"></i></td><td class="content">Определяет как сильно MQ обрабатывает доставку сообщений. Каждый уровень гарантии это своеобразный компромис между скоростью и уверенностью в обработанном сообщении.
С каждым уровнем система требует больших проверкок и подтверждений для гарантии, что сообщение было обработано.
Что влияет на пропусную способность.</td></tr></table></div>
<div class="paragraph"><p>Понимание гарантии доставки крайне важные при проектировани IPC. И может выбирать между пропускной способность или гарантией отправки сообщения.</p></div>
<div class="admonitionblock warning"><table><tr><td class="icon"><i class="fa fa-warning" title="Warning"></i></td><td class="content">Команда разработчиков должна понимать разницу и уметь правильно выбрать необходимый уровень качества доставки.</td></tr></table></div>
<div class="paragraph"><p>Для принятия решения важно анализировать бизнес требования функционала:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Насколько ценно сообщение?</p></li><li><p>Можем мы его потерять?</p></li><li><p>Что делать когда сообщение было утеряно?</p></li><li><p>Каие действия при системных ошибках следует предпринимать отправителю и/или подписчику?</p></li></ol></div>
<div class="paragraph"><div class="title">At most once (QoS 0)</div><p>В лучшем случае - отправит. Клиент не может знать хоть кто-то прочитает сообщение или нет! Еще называется “best-effort”</p></div>
<div class="paragraph"><p>Если никто не слушает subject или не активен в момент отправки сообщения - сообщение не будет доставлено.</p></div>
<div class="paragraph"><p>Такой же уровень гарантии предоставляет TCP/IP.</p></div>
<div class="paragraph"><p>Ядро отправляет и забывает сообщение. Он держит сообщения только в памяти и никогда не сохраняет их на диск.</p></div>
<div class="paragraph"><p>Обладает высокой пропускной способностью, т.к. накладные расходы это пропускная способность сети и CPU системы.</p></div>
<div class="paragraph"><div class="title">At-least once (QoS 1)</div><p>Клиент получает гарантию, что его сообщение будет сохранено.
На этом уровне гарантии клиент получает больше возможностей для отслеживания состояния его сообщения: если сообщение не будет отправлено он будет знать, что сообщение не было сохранено в стрим стор и нужно предпринять меры.</p></div>
<div class="paragraph"><div class="title">exactly once QoS (QoS 2)</div><p>Ideal when message rates are fairly low and where latency is not a primary concern.</p></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/nats-concepts/what-is-nats" class="bare">https://docs.nats.io/nats-concepts/what-is-nats</a></div><div class="footnote">2. <a href="https://developers.cloudflare.com/pub-sub/learning/delivery-guarantees" class="bare">https://developers.cloudflare.com/pub-sub/learning/delivery-guarantees</a></div></div></section><section id="_components" class="columns"><h2>Components</h2><div class="slide-content"><div class="openblock column"><div class="content"><div class="ulist"><div class="title">Functionality</div><ul><li><p>Core</p></li><li><p>JetStream</p></li></ul></div></div></div>
<div class="openblock column"><div class="title">Protocol</div><div class="content"><div class="ulist"><ul><li><p>NATS</p></li><li><p>MQTT <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></p></li><li><p>WebSocket <sup class="footnote">[<span class="footnote" title="View footnote.">2</span>]</sup></p></li></ul></div></div></div>
<div class="openblock column"><div class="title">Topology</div><div class="content"><div class="ulist"><ul><li><p>Single</p></li><li><p>Cluster <sup class="footnote">[<span class="footnote" title="View footnote.">3</span>]</sup></p></li><li><p>Gateway <sup class="footnote">[<span class="footnote" title="View footnote.">4</span>]</sup></p></li><li><p>Leaf <sup class="footnote">[<span class="footnote" title="View footnote.">5</span>]</sup></p></li></ul></div></div></div>
<div class="openblock column"><div class="title">Security <sup class="footnote">[<span class="footnote" title="View footnote.">6</span>]</sup></div><div class="content"><div class="ulist"><ul><li><p>Token</p></li><li><p>User/Password</p></li><li><p>TLS auth</p></li><li><p>NKeys</p></li><li><p>JWT</p></li></ul></div></div></div>
<aside class="notes"><div class="paragraph"><div class="title">Топологя</div><p>Как способ разворачивания, может быть развернута как <code>single node</code>, что не HA, в режиме кластера, сурер-кластер GateWay и Leaf протокол, который мы выбрали для построения нашего супер-кластера.</p></div>
<div class="ulist"><ul><li><p>Single - исключительно дев. окружение самого разработчика</p></li><li><p>Cluster - HA deployment, обычно с 3я нодами, повышает доступность и пропускную способность</p></li><li><p>Gateway - обьединяет несколько кластеров в полную сетку. Кластеры используются для обьединения node, в то время GW - для обьединения кластеров. Это LoadBalancer!!!</p></li><li><p>Leaf - расширяет существующую NATS систему в любом размере. Прозрачно перенаправляют сообщения с локальных клиентво к одной или больше удаленным системам и обратно.</p></li></ul></div>
<div class="paragraph"><div class="title">Безопасность</div><p>Важно понимать разницу между аккаунт и пользователь. Аккаунт - это просто субсет пользователей с рязом высокоуровневых различий.</p></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>Accounts allow the grouping of clients, isolating them from clients in other accounts, thus enabling multi-tenancy in the server. With accounts, the subject space is not globally shared, greatly simplifying the messaging environment. Instead of devising complicated subject name carving patterns, clients can use short subjects without explicit authorization rules. System Events are an example of this isolation at work.</p></div></blockquote></div>
<div class="paragraph"><p>Аккаунт строго разделяется на системный и обычный. Так же аккаунт обязательно должен иметь включенную опцию <strong>jetstream</strong>, без нее все пользователи будут использовать только CORE функционал</p></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="fa fa-exclamation-circle" title="Important"></i></td><td class="content">Jetstream аккаунт не может быть системным.</td></tr></table></div>
<div class="paragraph"><p>У нас принята конвенция использовать 2 вида аккаунтов: <code>SYS</code> и <code>ACC</code></p></div>
<div class="paragraph"><p>Про методы аутентификации:</p></div>
<div class="paragraph"><div class="title">Token</div><p>Это единый токен для подключения. Для авторизации используется поле <code>user</code> у пользователя нет ограничений, но он принадлежит не системному аккаунту.</p></div>
<div class="paragraph"><div class="title">User/Password</div><p>Тут все просто. Это очень удобный механизм, т.к. позволяет легко настраивать права выбранных пользователей. Каждый пользователь может быть изолирован даже по типу подключения:</p></div>
<div class="paragraph"><div class="title">TLS auth</div><p>Клиент предоставляет сертификат подписанный рутовым сертификатом установленным конкретному кластеру. Мапинг пользователей осуществялется через данные указанные при регистрации пользователя.</p></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>Subject Alternative Name (SAN) maps to a user. It will search all email addresses first, then all DNS names. If no user could be found, it will try the certificate subject.</p></div></blockquote></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">Certificate:
...
        X509v3 extensions:
            X509v3 Subject Alternative Name:
                DNS:localhost, IP Address:0:0:0:0:0:0:0:1, email:email@localhost
            X509v3 Extended Key Usage:
                TLS Web Client Authentication
...</code></pre></div></div>
<div class="paragraph"><p>Можно использовать RFC 2253 Distinguished Names (распределенные имена)  синтаксис описать пользователя относящегося с предметом сервтификата</p></div>
<div class="listingblock"><div class="content"><pre class="highlight"><code class="language-yaml" data-lang="yaml">authorization {
  users = [
    {user: "OU=testuser@MacBook-Pro.local (Test User),O=mkcert development certificate"}
  ]
}</code></pre></div></div>
<div class="paragraph"><div class="title">NKeys</div><p>Современная система публичной сигнатуры ключа основанной на Ed25519. Позволяет идентифицировать пользователя без хранения или видения приватного ключа.</p></div>
<div class="paragraph"><p>Настраивается намного легче, т.к. на сервере мы указываем публичный хэш ключа и далее его уже привязываем к группе прав.</p></div>
<div class="paragraph"><p>Тут по прежнему нам нужен приватный ключ для клиента, но на стороне сервера - только приватный ключ, что упрощает обслуживание.</p></div>
<div class="paragraph"><div class="title">JWT</div><p>Открытый стандарт RFC7519 метод для безопасного предоставления запросов между двумя распределенными частями.</p></div>
<div class="paragraph"><p>Подпись осуществляется через Ed25519 алгоритм. Все <code>Issuer</code> и <code>Subject</code> поля ключи - публичные NKEY которые.</p></div>
<div class="paragraph"><p><code>Issuer</code> и <code>Subject</code> - залинкованы на  следующие роли:</p></div>
<div class="ulist"><ul><li><p>Operators</p></li><li><p>Accounts</p></li><li><p>Users</p></li></ul></div></aside></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/running-a-nats-service/configuration/mqtt" class="bare">https://docs.nats.io/running-a-nats-service/configuration/mqtt</a></div><div class="footnote">2. <a href="https://docs.nats.io/running-a-nats-service/configuration/websocket" class="bare">https://docs.nats.io/running-a-nats-service/configuration/websocket</a></div><div class="footnote">3. <a href="https://docs.nats.io/running-a-nats-service/configuration/clustering" class="bare">https://docs.nats.io/running-a-nats-service/configuration/clustering</a></div><div class="footnote">4. <a href="https://docs.nats.io/running-a-nats-service/configuration/gateways" class="bare">https://docs.nats.io/running-a-nats-service/configuration/gateways</a></div><div class="footnote">5. <a href="https://docs.nats.io/running-a-nats-service/configuration/leafnodes" class="bare">https://docs.nats.io/running-a-nats-service/configuration/leafnodes</a></div><div class="footnote">6. <a href="https://docs.nats.io/running-a-nats-service/configuration/securing_nats/auth_intro" class="bare">https://docs.nats.io/running-a-nats-service/configuration/securing_nats/auth_intro</a></div></div></section></section>
<section id="_core"><h2>Core</h2><div class="slide-content"><aside class="notes"><div class="paragraph"><p>Я хочу сразу оговорить, что есть CORE функционал, и комьюнити
С JetStream появилось несколько особенностей архитектуры, с которой многие разработчики путаются.</p></div>
<div class="paragraph"><p>Важно понимать, что JetStream расширяет возможности NATS новым функционалом и это решать разработчику, какой именно механизм ему стоит исползовать.</p></div></aside></div></section>
<section><section id="_jetstream"><h2>JetStream</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>NATS has a built-in distributed persistence system called JetStream which enables new functionalities and higher qualities of service on top of the base 'Core NATS' functionalities and qualities of service.</p></div></blockquote></div><div class="paragraph"><p>JetStream is designed to bifurcate ingestion and consumption of messages to provide multiple ways to consume data from the same stream. To that end, JetStream functionality is composed of server streams that hold data and server consumers that provide a way for applications to access data. Streams and consumers may be provisioned ahead of time, at runtime, and are independently configured to provide the flexibility to balance performance and reliability and create the perfect environment for your business needs.</p></div><div class="imageblock"><img src="images/streams-and-consumers-75p.png" alt="streams and consumers 75p"></div></div></section><section id="_goals_1"><h2>Goals <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>JetStream was developed with the following goals in mind</p></div>
<div class="ulist"><ul><li class="fragment"><p>The system must be easy to configure and operate and be observable.</p></li><li class="fragment"><p>The system must be secure and operate well with NATS 2.0 security models.</p></li><li class="fragment"><p>The system must scale horizontally and be applicable to a high ingestion rate.</p></li><li class="fragment"><p>The system must support multiple use cases.</p></li><li class="fragment"><p>The system must self-heal and always be available.</p></li><li class="fragment"><p>The system must have an API that is closer to core NATS.</p></li><li class="fragment"><p>The system must allow NATS messages to be part of a stream as desired.</p></li><li class="fragment"><p>The system must display payload agnostic behavior.</p></li><li class="fragment"><p>The system must not have third party dependencies.</p></li></ul></div></div><div class="footnotes"><div class="footnote">1. A footnote on introduction?!</div></div></section><section id="_raft_1_2" class="columns wrap"><h2>RAFT <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup> <sup class="footnote">[<span class="footnote" title="View footnote.">2</span>]</sup></h2><div class="slide-content"><div class="openblock column is-one-third has-text-justified"><div class="content"><div class="paragraph"><p><strong>Meta Group</strong> - all servers join the Meta Group and the JetStream API is managed by this group. A leader is elected and this owns the API and takes care of server placement.</p></div></div></div>
<div class="openblock column is-one-third has-text-justified"><div class="content"><div class="paragraph"><p><strong>Stream Group</strong> - each Stream creates a RAFT group, this group synchronizes state and data between its members. The elected leader handles ACKs and so forth, if there is no leader the stream will not accept messages.</p></div></div></div>
<div class="openblock column is-one-third has-text-justified"><div class="content"><div class="paragraph"><p><strong>Consumer Group</strong> - each Consumer creates a RAFT group, this group synchronizes consumer state between its members. The group will live on the machines where the Stream Group is and handle consumption ACKs etc. Each Consumer will have their own group.</p></div></div></div>
<div class="openblock column is-one-third"><div class="content"><div class="imageblock"><img src="images/meta_group.png" alt="meta group" width="40%"></div></div></div>
<div class="openblock column is-one-third"><div class="content"><div class="imageblock"><img src="images/stream_group.png" alt="stream group" width="40%"></div></div></div>
<div class="openblock column is-one-third"><div class="content"><div class="imageblock"><img src="images/consumer_group.png" alt="consumer group" width="40%"></div></div></div></div><div class="footnotes"><div class="footnote">1. <a href="https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering" class="bare">https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering</a></div><div class="footnote">2. <a href="https://raft.github.io/" class="bare">https://raft.github.io/</a></div></div></section></section>
<section><section id="_what_expect_next"><h2>What expect next?</h2></section><section id="_release_2_9_1"><h2>Release 2.9 <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="paragraph"><p>context</p></div></div><div class="footnotes"><div class="footnote">1. <a href="https://nats.io/blog/nats-server-29-release" class="bare">https://nats.io/blog/nats-server-29-release</a></div></div></section><section id="_road_map"><h2>Road map</h2><div class="slide-content"><div class="imageblock"><img src="images/roadmap.png" alt="roadmap"></div></div></section></section>
<section id="_pin_up_infrastructure"><h2>Pin-Up Infrastructure</h2><div class="slide-content"><div class="imageblock"><img src="images/NATS%20LEAF-DEV.png" alt="NATS LEAF DEV"></div></div></section>
<section id="_references"><h2>References</h2><div class="slide-content"><div class="ulist"><ul><li><p><a href="https://github.com/nats-io/nats.docs/tree/master/running-a-nats-service/configuration">Nats.Docs</a></p></li><li><p><a href="https://nats.io/blog/building-scalable-microservices-with-nats/">Building Microservices with NATS</a></p></li><li><p><a href="https://docs.nats.io/nats-concepts/jetstream">JetStream</a>, at  <a href="https://github.com/nats-io/nats.docs/blob/master/nats-concepts/jetstream/readme.md">Nats.Docs</a></p></li><li><p><a href="https://nats.io/blog/nats-whats-new-22/">NATS Server 2.2 Release</a></p></li><li><p><a href="https://nats.io/blog/nats-server-29-release/">NATS Server 2.9 Release</a></p></li><li><p><a href="https://www.youtube.com/watch?v=HwwvFeUHAyo&amp;t=1s">Benchmark</a></p></li><li><p><a href="https://raft.github.io/">RAFT</a></p></li></ul></div></div></section>
<section id="_contacts"><h2>Contacts</h2><div class="slide-content"><div class="paragraph"><p><span class="icon"><i class="fa fa-envelope fa-lg"></i></span> <a href="mailto:d.harupa@pin-up.team">d.harupa@pin-up.team</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-envelope fa-lg"></i></span> <a href="mailto:d7561985@gmail.com">d7561985@gmail.com</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-github fa-lg"></i></span> <a href="https://github.com/d7561985" class="bare">https://github.com/d7561985</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-linkedin fa-lg"></i></span> <a href="https://linkedin.com/in/dzmitry-harupa-332131137" class="bare">https://linkedin.com/in/dzmitry-harupa-332131137</a></p></div>
<div class="paragraph"><p><span class="icon"><i class="fa fa-instagram fa-lg"></i></span> dzmityinv</p></div></div></section></div></div><script src="node_modules/reveal.js/dist/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: true,
  // Push each slide change to the browser history. Implies `hash: true`
  history: false,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: false,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 2700,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1920,
  height: 1080,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'node_modules/reveal.js/plugin/zoom/zoom.js', async: true, callback: function () { Reveal.registerPlugin(RevealZoom) } },
      { src: 'node_modules/reveal.js/plugin/notes/notes.js', async: true, callback: function () { Reveal.registerPlugin(RevealNotes) } }
  ],
});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1920, 1080)
});</script></body></html>